import 'dart:convert';

import 'package:sqlite3/sqlite3.dart';
import 'new_scheme.dart' as new_scheme;
import 'old_scheme.dart' as old_scheme;

void main(List<String> arguments) {
  final db = sqlite3.open('storage.db');
  final resultSet = db.select('SELECT id,data_date,data FROM portfolio');
  for (var row in resultSet) {
    final id = row['id'];
    final data = json.decode(row['data']);
    try {
      final oldScheme = old_scheme.Autogenerated.fromJson(data);

      try {
        final newScheme = new_scheme.Autogenerated();
        newScheme.dollar = new_scheme.Dollar(
            currency: oldScheme.dollar.currency, value: oldScheme.dollar.value);

        final parts = <new_scheme.Parts>[];
        for (var oldPart in oldScheme.parts) {
          parts.add(new_scheme.Parts(
              price: oldPart.price != null ? oldPart.price.value : null,
              deviation:
                  oldPart.deviation != null ? oldPart.deviation.value : null,
              deviationPercent: oldPart.deviationPercent,
              ratio: oldPart.ratio,
              type: oldPart.type));
        }

        newScheme.parts = parts;
        final ndata = json.encode(newScheme.toJson());
        final stmt = db.prepare('UPDATE portfolio SET data=? WHERE id=?');
        stmt.execute([ndata, id]);
        stmt.dispose();
      } catch (d) {
        print(d);
      }
    } catch (e) {
      //
    }
  }
}
